<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestFlow Pro 8.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // Âº∑ÂåñÂÆâÂÖ®ÊÄßÔºöÈò≤Ê≠¢ Recharts Â∞öÊú™ËºâÂÖ•ÂÆåÊàêÂ∞éËá¥ÁöÑÂ¥©ÊΩ∞
        const Lib = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, AreaChart, Area, BarChart, Bar } = Lib;

        const SUPABASE_URL = "https://quugdrntvrmlndqgoshk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1dWdkcm50dnJtbG5kcWdvc2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjkyMTksImV4cCI6MjA4MjkwNTIxOX0.WMMa-iju0V8JwY89EK0lAelNIBtw02OwcCVE2W5k6yM";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState("home");
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [records, setRecords] = useState([]);
            const [apiKeys, setApiKeys] = useState([]);
            const [mainForm, setMainForm] = useState({ amount: "", deposit: "", withdrawal: "", note: "", date: new Date().toISOString().slice(0, 16) });
            const [apiForm, setApiForm] = useState({ exchange: "binance", key: "", secret: "" });

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => setUser(session?.user ?? null));
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setUser(session?.user ?? null));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => { if (user) { fetchData(); fetchApiKeys(); } }, [user]);

            const fetchData = async () => {
                const { data } = await supabase.from("records").select("*").order("date", { ascending: true });
                if (data) setRecords(data);
            };

            const fetchApiKeys = async () => {
                const { data } = await supabase.from("exchange_keys").select("*");
                if (data) setApiKeys(data);
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                await supabase.from("records").insert([{
                    user_id: user.id,
                    date: new Date(mainForm.date).toISOString(),
                    amount: parseFloat(mainForm.amount),
                    deposit: parseFloat(mainForm.deposit || 0),
                    withdrawal: parseFloat(mainForm.withdrawal || 0)
                }]);
                setMainForm({ ...mainForm, amount: "" });
                fetchData();
            };

            const handleSaveApi = async (e) => {
                e.preventDefault();
                await supabase.from("exchange_keys").insert([{
                    user_id: user.id, exchange: apiForm.exchange, api_key: apiForm.key, api_secret: apiForm.secret
                }]);
                setApiForm({ exchange: "binance", key: "", secret: "" });
                fetchApiKeys();
                alert("API ÂÑ≤Â≠òÊàêÂäü");
            };

            const data = useMemo(() => {
                let flow = 0;
                return records.map((r, i) => {
                    flow += (parseFloat(r.deposit || 0) - parseFloat(r.withdrawal || 0));
                    return { ...r, d: new Date(r.date).toLocaleDateString(), "ÂØ¶Èöõ": r.amount, "ÈÇÑÂéü": r.amount - flow };
                });
            }, [records]);

            if (!user) return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white font-black p-10">
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const email = e.target.email.value;
                        const password = e.target.pw.value;
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) await supabase.auth.signUp({ email, password });
                    }} className="bg-white p-10 rounded-[2.5rem] w-full max-w-sm space-y-4 text-slate-900">
                        <h1 className="text-3xl text-center italic mb-8">InvestFlow</h1>
                        <input name="email" type="email" placeholder="Email" className="w-full p-4 bg-slate-100 rounded-2xl outline-none" required />
                        <input name="pw" type="password" placeholder="Password" className="w-full p-4 bg-slate-100 rounded-2xl outline-none" required />
                        <button className="w-full bg-indigo-600 text-white py-4 rounded-2xl shadow-lg font-black">LOGIN / START</button>
                    </form>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 pb-10">
                    <header className="h-16 flex items-center px-6 bg-white border-b sticky top-0 z-50 justify-between">
                        <button onClick={() => setIsDrawerOpen(true)} className="p-2 bg-slate-100 rounded-xl">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <span className="font-black text-xs tracking-widest">{activeTab.toUpperCase()}</span>
                        <div className="w-8"></div>
                    </header>

                    {/* Drawer */}
                    <div className={`fixed inset-0 bg-black/40 z-50 ${isDrawerOpen ? "block" : "hidden"}`} onClick={() => setIsDrawerOpen(false)}>
                        <div className="w-72 bg-white h-full p-8 space-y-4 font-black" onClick={e => e.stopPropagation()}>
                            <h2 className="text-2xl text-indigo-600 italic mb-10">Invest Pro</h2>
                            <button onClick={() => { setActiveTab("home"); setIsDrawerOpen(false); }} className="w-full text-left p-4 hover:bg-slate-50 rounded-xl">üè† Â∏≥Êú¨È¶ñÈ†Å</button>
                            <button onClick={() => { setActiveTab("analysis"); setIsDrawerOpen(false); }} className="w-full text-left p-4 hover:bg-slate-50 rounded-xl">üìà Á∏æÊïàÊü•Ë©¢</button>
                            <button onClick={() => { setActiveTab("settings"); setIsDrawerOpen(false); }} className="w-full text-left p-4 hover:bg-slate-50 rounded-xl">‚öôÔ∏è ‰∫§ÊòìÊâÄË®≠ÂÆö</button>
                            <button onClick={() => supabase.auth.signOut()} className="text-rose-400 p-4 mt-10">ÁôªÂá∫</button>
                        </div>
                    </div>

                    <main className="max-w-4xl mx-auto p-4 md:p-8 space-y-8">
                        {activeTab === "home" && (
                            <>
                                <div className="bg-white p-6 rounded-[2rem] shadow-sm h-64 border border-slate-100">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={data}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="d" hide />
                                            <YAxis hide domain={["auto", "auto"]} />
                                            <Tooltip />
                                            <Line type="monotone" dataKey="ÂØ¶Èöõ" stroke="#4f46e5" strokeWidth={4} dot={false} />
                                            <Line type="monotone" dataKey="ÈÇÑÂéü" stroke="#f59e0b" strokeWidth={4} dot={false} strokeDasharray="5 5" />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                                <form onSubmit={handleAdd} className="bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl text-white space-y-4">
                                    <input type="number" step="0.01" placeholder="‰ªäÊó•Á∏ΩË≥áÁî¢" value={mainForm.amount} onChange={e => setMainForm({ ...mainForm, amount: e.target.value })} className="w-full bg-slate-800 p-6 rounded-2xl font-black text-4xl text-white outline-none" required />
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="number" placeholder="ÂÖ•Èáë" value={mainForm.deposit} onChange={e => setMainForm({ ...mainForm, deposit: e.target.value })} className="p-4 bg-slate-800 rounded-2xl text-green-400 font-bold" />
                                        <input type="number" placeholder="Âá∫Èáë" value={mainForm.withdrawal} onChange={e => setMainForm({ ...mainForm, withdrawal: e.target.value })} className="p-4 bg-slate-800 rounded-2xl text-rose-400 font-bold" />
                                    </div>
                                    <button className="w-full bg-indigo-600 py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl">ÂÑ≤Â≠òÁ¥ÄÈåÑ</button>
                                </form>
                            </>
                        )}

                        {activeTab === "settings" && (
                            <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 space-y-6">
                                <h3 className="font-black text-xl italic text-indigo-600">Exchange API</h3>
                                <form onSubmit={handleSaveApi} className="space-y-4 font-bold text-slate-700">
                                    <select value={apiForm.exchange} onChange={e => setApiForm({ ...apiForm, exchange: e.target.value })} className="w-full p-4 bg-slate-50 rounded-2xl border-none">
                                        <option value="binance">Binance</option>
                                        <option value="okx">OKX</option>
                                    </select>
                                    <input placeholder="API Key" value={apiForm.key} onChange={e => setApiForm({ ...apiForm, key: e.target.value })} className="w-full p-4 bg-slate-50 rounded-2xl border-none" required />
                                    <input type="password" placeholder="API Secret" value={apiForm.secret} onChange={e => setApiForm({ ...apiForm, secret: e.target.value })} className="w-full p-4 bg-slate-50 rounded-2xl border-none" required />
                                    <button className="w-full bg-slate-900 text-white py-4 rounded-2xl shadow-lg font-black">ÂÑ≤Â≠ò API</button>
                                </form>
                            </div>
                        )}

                        {activeTab === "analysis" && (
                            <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 text-center font-black py-20">
                                <p className="text-slate-400">Á∏æÊïàÊ∑±Â∫¶ÂàÜÊûêÂäüËÉΩËºâÂÖ•‰∏≠...</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>